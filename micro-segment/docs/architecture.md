# 架构设计

## 系统架构

微隔离系统采用三层架构设计：

```
┌─────────────────────────────────────────────────────────────┐
│                    Web UI (React)                            │
│  - 策略管理界面                                               │
│  - 网络拓扑可视化                                             │
│  - 连接监控                                                   │
└────────────────────┬────────────────────────────────────────┘
                     │ REST API (HTTPS)
┌────────────────────▼────────────────────────────────────────┐
│                    Controller                                │
│  - REST API服务器                                            │
│  - gRPC服务器                                                │
│  - 策略管理和分发                                             │
│  - 网络拓扑图维护 (wlGraph)                                  │
│  - 持久化存储 (etcd)                                         │
└────────────────────┬────────────────────────────────────────┘
                     │ gRPC
┌────────────────────▼────────────────────────────────────────┐
│                    Agent (每个节点)                          │
│  - 容器生命周期监控                                           │
│  - 策略接收和转换                                             │
│  - 连接聚合 (5秒)                                            │
│  - DP通信                                                    │
└────────────────────┬────────────────────────────────────────┘
                     │ Unix Socket (JSON)
┌────────────────────▼────────────────────────────────────────┐
│                    DP (数据平面)                             │
│  - 策略匹配引擎 (RCU哈希表)                                  │
│  - DPI深度检测                                               │
│  - 网络流量拦截 (NFQ/TC)                                     │
│  - 会话管理                                                   │
└─────────────────────────────────────────────────────────────┘
```

## 核心组件

### 1. Controller

**职责**：
- 集中式策略管理
- 网络拓扑图维护
- Agent管理
- 数据持久化

**关键模块**：
- `api/` - REST API服务
- `rpc/` - gRPC服务
- `cache/` - 内存缓存（策略、组、拓扑图）
- `storage/` - 持久化存储接口

**数据流**：
1. 用户通过Web UI创建策略
2. Controller验证并存储策略
3. 通过gRPC推送到所有Agent
4. Agent上报连接数据
5. Controller更新网络拓扑图

### 2. Agent

**职责**：
- 监控容器生命周期
- 策略转换和下发
- 连接数据聚合
- 与Controller和DP通信

**关键模块**：
- `engine/` - 容器引擎
- `policy/` - 策略计算
- `connection/` - 连接聚合器
- `dp/` - DP客户端
- `probe/` - 容器监控

**数据流**：
1. 监听容器运行时事件
2. 接收Controller下发的策略
3. 转换为DP策略格式
4. 通过Unix Socket发送到DP
5. 从DP收集连接数据
6. 聚合后上报到Controller

### 3. DP (数据平面)

**职责**：
- 实时策略匹配
- 流量拦截和控制
- DPI应用层检测
- 会话管理

**关键模块**：
- `dpi/` - DPI引擎
- `ctrl/` - 控制接口
- `nfq/` - Netfilter队列
- `utils/` - 工具库（RCU哈希表）

**数据流**：
1. 接收Agent下发的策略
2. 加载到RCU哈希表
3. 拦截网络数据包
4. 执行策略匹配
5. 允许/拒绝流量
6. 记录连接信息

## 策略执行流程

### 策略下发

```
用户创建策略
    ↓
Controller验证策略
    ↓
存储到etcd
    ↓
推送到所有Agent (gRPC)
    ↓
Agent转换策略
    ├─ 解析组成员
    ├─ 填充IP地址
    ├─ 创建规则
    └─ 调整动作（根据模式）
    ↓
发送到DP (Unix Socket)
    ↓
DP加载策略
    ├─ 解析JSON
    ├─ 创建规则键
    ├─ 添加到policy_map
    └─ 更新版本号
```

### 流量匹配

```
数据包到达
    ↓
DP拦截 (NFQ/TC)
    ↓
提取5元组
    ├─ 源IP
    ├─ 目标IP
    ├─ 目标端口
    ├─ 协议
    └─ 应用ID
    ↓
策略查找
    ├─ 精确匹配 (policy_map)
    ├─ 范围匹配 (range_policy_map)
    └─ 默认动作
    ↓
执行动作
    ├─ ALLOW: 转发
    ├─ DENY: 丢弃
    ├─ VIOLATE: 记录+转发/丢弃
    └─ CHECK_APP: DPI检测
    ↓
记录连接信息
    ↓
上报到Agent
```

## 连接聚合流程

```
DP记录连接
    ↓
Agent定时收集 (5秒)
    ↓
连接聚合
    ├─ 合并相同连接
    ├─ 更新统计信息
    └─ 填充工作负载信息
    ↓
检查connectionMap
    ├─ 未满: 添加
    ├─ 已满: 
    │   ├─ 高优先级: 强制添加
    │   └─ 低优先级: 丢弃
    ↓
批量上报到Controller (gRPC)
    ↓
Controller更新拓扑图
    ├─ 添加/更新节点
    ├─ 添加/更新连接
    └─ 更新统计信息
```

## 网络拓扑图

### 数据结构

```go
type Graph struct {
    Nodes map[string]*Node      // 工作负载节点
    Links map[string]*Link      // 连接链接
    mutex sync.RWMutex
}

type Node struct {
    ID         string
    Name       string
    Type       string  // container, node, external
    Group      string
    PolicyMode string
}

type Link struct {
    ID           string
    Source       string  // 源节点ID
    Target       string  // 目标节点ID
    Bytes        uint64
    Sessions     uint32
    Threats      uint32
    PolicyAction string
    LastSeen     time.Time
}
```

### 更新流程

```
接收连接上报
    ↓
提取节点信息
    ├─ ClientWL
    └─ ServerWL
    ↓
更新/创建节点
    ↓
提取连接信息
    ├─ 源-目标
    ├─ 字节数
    ├─ 会话数
    └─ 策略动作
    ↓
更新/创建链接
    ↓
清理过期数据
    ├─ 超时连接
    └─ 离线节点
```

## 策略模式

### Monitor模式

- 记录所有流量
- 违规流量不阻断
- 策略动作：VIOLATE
- 用途：观察和调试

### Protect模式

- 实时阻断违规流量
- 策略动作：DENY
- 用途：生产环境防护

## 性能优化

### DP层

1. **无锁并发**：使用RCU (Read-Copy-Update)
2. **哈希表**：O(1)策略查找
3. **多线程**：并行处理数据包
4. **零拷贝**：减少内存拷贝

### Agent层

1. **连接聚合**：减少上报频率
2. **批量处理**：批量发送连接
3. **优先级队列**：高优先级连接优先
4. **缓存策略**：避免重复计算

### Controller层

1. **内存缓存**：减少存储访问
2. **增量更新**：仅推送变化
3. **异步处理**：非阻塞操作
4. **连接池**：复用gRPC连接

## 扩展性

### 水平扩展

- Controller：多实例部署（主从选举）
- Agent：每节点一个实例
- DP：每容器一个实例

### 容量规划

- 单Controller：10K节点
- 单Agent：1K容器
- 单DP：100K并发连接
- connectionMap：131K连接

## 高可用

### Controller

- 多实例部署
- etcd集群存储
- 主从选举（Raft）
- 故障自动切换

### Agent

- 本地策略缓存
- Controller断线重连
- 策略持久化

### DP

- 策略版本控制
- 优雅重启
- 连接状态保持

## 安全性

### 通信安全

- gRPC TLS加密
- REST API HTTPS
- Unix Socket权限控制

### 认证授权

- JWT Token认证
- RBAC权限控制
- API密钥管理

### 数据安全

- 敏感数据加密
- 审计日志
- 访问控制

## 监控指标

### DP指标

- 策略匹配延迟
- 数据包处理速率
- 策略规则数量
- 会话数量

### Agent指标

- 连接聚合速率
- 上报延迟
- 容器数量
- 策略更新延迟

### Controller指标

- API请求速率
- 拓扑图节点数
- 连接数量
- 存储延迟
